<!DOCTYPE html>
<html>

<head>
	<style type="text/css">
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#map {
			height: 100%;
		}
	</style>
	<script src="./markerclusterer.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
</head>

<body>
	<div id="map"></div>

	<script type="text/javascript">

		var map;

		var options = {
			center: {
				lat: 51.5286416,
				lng: -0.1015987
			},
			zoom: 12,
		}

		var mcOptions = {
			gridSize: 50,
			maxZoom: 17,
      imagePath: 'images/m'
		};

		var markers = [];

		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), options);

			var infowindow = new google.maps.InfoWindow({
				content: ""
			});

      var mainUrlApi = "https://data.police.uk/api/crimes-at-location?date=";

      function generateDates(){
        var dates = []
        var currentDate = getCurrentDate()
        //first year of data is 2011
        for(var year = 2011; year <= currentDate.year; year++){
          for(var month = 1; month <= 12; month++){
            //skip the latest 3 months, lazy
            if(year == currentDate.year && currentDate.month < month + 3){
              break;
            }
            dates.push(year+"-"+month)
          }
        }
        return dates;
      }

      function getCurrentDate(){
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth();
        return {
         "year":year,
         "month":month
       };
      }

			if (navigator.geolocation) {
				var geoOptions = function() {
					return {
						maximumAge: 5 * 60 * 1000,
						timeout: 10 * 1000
					}
				};
				var geoSuccess = function(position) {
          var allResults = [];
          var allDates = generateDates();
          $.each(generateDates(), function(i,date){
            $.ajax(mainUrlApi+date+"&lat="+position.coords.latitude+"&lng="+position.coords.longitude)
            .done(function(result) {
              allResults.push(result);
              if(i == allDates.length - 1){ //when all are done
                handleDataFromPoliceApi(allResults);
              }
            })
          })
				};
				var geoError = function(position) {

					return;

				};

				navigator.geolocation.getCurrentPosition(geoSuccess, geoError, geoOptions);
			}

      function handleDataFromPoliceApi(result){
        for (var j = 0; j < result.length; j++) {
          for (var i = 0; i < result[j].length; i++) {
            var dataCategory = result[j][i].category;
            var dataMonth = result[j][i].month;
            var dataStreet = result[j][i].location.street.name;

            var latLng = new google.maps.LatLng(result[j][i].location.latitude,
            	result[j][i].location.longitude);
              console.log(result[j][i].location.latitude)
              console.log(result[j][i].location.longitude)
            var marker = new google.maps.Marker({
            	position: latLng,
              map:map,
            	title: dataCategory
            });
            markers.push(marker);
            bindInfoWindow(marker, map, infowindow, dataCategory, dataMonth, dataStreet);
          }
        }
      }

        var mc = new MarkerClusterer(map, markers, mcOptions);
        function bindInfoWindow(marker, map, infowindow, category, month, street) {
          google.maps.event.addListener(marker, 'click', function() {
            var contentString = '<div id="content"><div id="siteNotice">' +
              '</div><h1 id="firstHeading" class="firstHeading">' + category +
              '</h1><div id="bodyContent"><p>"' + month + '"</p><p>"' + street + '"</p></div>' +
              '</div>';
            map.setCenter(marker.getPosition());
            infowindow.setContent(contentString);
            infowindow.open(map, marker);
          });
        }

		}
	</script>
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCz3PtfsIRnrl9FLJm_PWJNrv0ovjaey_U &callback=initMap">
	</script>
</body>

</html>
